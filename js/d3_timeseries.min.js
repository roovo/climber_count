!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3")):"function"==typeof define&&define.amd?define(["d3"],e):t.d3_timeseries=e(t.d3)}(this,function(L){"use strict";var r=["#a6cee3","#ff7f00","#b2df8a","#1f78b4","#fdbf6f","#33a02c","#cab2d6","#6a3d9a","#fb9a99","#e31a1c","#ffff99","#b15928"];function P(e){return"function"==typeof e?e:function(t){return t[e]}}function j(e,a){var n="function"==typeof e?e:function(t){return t[e]};return function(t){return a(n(t))}}function B(e){return function(t){return t.hasOwnProperty(e)&&null!==t[e]&&!isNaN(t[e])}}function O(e){return function(t){return t[e]}}return function(){var s=480,l=600,d=80,c=10,f={top:10,bottom:20,left:30,right:10},p=[],u=L.scaleLinear(),m=L.scaleTime();u.label="",m.label="";var h,y,x,g,v,b,k,_,w=L.brushX();u.setformat=function(t){return t.toLocaleString()},m.setformat=m.tickFormat();var a=function(t,e){var a='<table style="border:none">'+e.filter(function(t){return void 0!==t.item&&null!==t.item}).map(function(t){return'<tr><td style="color:'+t.options.color+'">'+t.options.label+' </td><td style="color:#333333;text-align:right">'+u.setformat(t.item[t.aes.y])+"</td></tr>"}).join("")+"</table>";return"<h4>"+L.timeFormat("%b %e %H:%M")(t)+"</h4>"+a};function A(a){var n=a.aes;a.options.interpolate?a.options.interpolate="monotone"==a.options.interpolate?"monotoneX":"step-after"==a.options.interpolate?"stepAfter":"step-before"==a.options.interpolate?"stepBefore":a.options.interpolate:a.options.interpolate="linear";var t="curve"+a.options.interpolate[0].toUpperCase()+a.options.interpolate.slice(1);a.interpolationFunction=L[t]||L.curveLinear;var e,r=L.line().x(j(n.x,m)).y(j(n.y,u)).curve(a.interpolationFunction).defined(B(n.y));a.line=r,a.options.label=a.options.label||a.options.name||a.aes.label||a.aes.y,n.ci_up&&n.ci_down&&(e=L.area().x(j(n.x,m)).y0(j(n.ci_down,u)).y1(j(n.ci_up,u)).curve(a.interpolationFunction),a.ciArea=e),n.diff&&(a.diffAreas=[L.area().x(j(n.x,m)).y0(j(n.y,u)).y1(function(t){return t[n.y]>t[n.diff]?u(t[n.diff]):u(t[n.y])}).curve(a.interpolationFunction),L.area().x(j(n.x,m)).y1(j(n.y,u)).y0(function(t){return t[n.y]<t[n.diff]?u(t[n.diff]):u(t[n.y])}).curve(a.interpolationFunction)]),a.find=function(t){var e=(0,L.bisector(O(n.x)).left)(a.data,t)-1;return-1==e||e==a.data.length-1&&1<a.data.length&&Number(t)-Number(a.data[e][n.x])>Number(a.data[e][n.x])-Number(a.data[e-1][n.x])?null:a.data[e]}}function F(n){var r;n.linepath?(n.linepath.attr("d",n.line),n.ciArea&&n.cipath.attr("d",n.ciArea),n.diffAreas&&(n.diffpaths[0].attr("d",n.diffAreas[0]),n.diffpaths[1].attr("d",n.diffAreas[1]))):(r=x.append("path").datum(n.data).attr("class","d3_timeseries line").attr("d",n.line).attr("stroke",n.options.color).attr("stroke-linecap","round").attr("stroke-width",n.options.width||1.5).attr("fill","none"),n.options.dashed&&(1==n.options.dashed||"dashed"==n.options.dashed?n["stroke-dasharray"]="5,5":"long"==n.options.dashed?n["stroke-dasharray"]="10,10":"dot"==n.options.dashed?n["stroke-dasharray"]="2,4":n["stroke-dasharray"]=n.options.dashed,r.attr("stroke-dasharray",n["stroke-dasharray"])),n.linepath=r,n.ciArea&&(n.cipath=x.insert("path",":first-child").datum(n.data).attr("class","d3_timeseries ci-area").attr("d",n.ciArea).attr("stroke","none").attr("fill",n.options.color).attr("opacity",n.options.ci_opacity||.3)),n.diffAreas&&(n.diffpaths=n.diffAreas.map(function(t,e){var a=(n.options.diff_colors?n.options.diff_colors:["green","red"])[e];return x.insert("path",function(){return r.node()}).datum(n.data).attr("class","d3_timeseries diff-area").attr("d",t).attr("stroke","none").attr("fill",a).attr("opacity",n.options.diff_opacity||.5)})))}function N(e){var t=g.selectAll("circle.d3_timeseries.focusring");(t=null==e?t.data([]):t.data(p.map(function(t){return{x:e,item:t.find(e),aes:t.aes,color:t.options.color}}).filter(function(t){return void 0!==t.item&&null!==t.item&&null!==t.item[t.aes.y]&&!isNaN(t.item[t.aes.y])}))).transition().duration(50).attr("cx",function(t){return m(t.item[t.aes.x])}).attr("cy",function(t){return u(t.item[t.aes.y])}),t.enter().append("circle").attr("class","d3_timeseries focusring").attr("fill","none").attr("stroke-width",2).attr("r",5).attr("stroke",O("color")),t.exit().remove()}function e(e){var t;null==e?_.style("opacity",0):(t=p.map(function(t){return{item:t.find(e),aes:t.aes,options:t.options}}),_.style("opacity",.9).style("left",f.left+5+m(e)+"px").style("top","0px").html(a(e,t)))}function E(){var t=L.mouse(y.node())[0],t=m.invert(t);b.datum({x:t,visible:!0}),b.update(),N(t),e(t)}function M(){b.datum({x:null,visible:!1}),b.update(),N(null),e(null)}function n(t){p=p.map(function(t){var e=L.extent(t.data.map(P(t.aes.y)));return t.min=e[0],t.max=e[1],e=L.extent(t.data.map(P(t.aes.x))),t.dateMin=e[0],t.dateMax=e[1],t}),u.range([s-f.top-f.bottom-d-c,0]).domain([L.min(p.map(O("min"))),L.max(p.map(O("max")))]).nice(),m.range([0,l-f.left-f.right]).domain([L.min(p.map(O("dateMin"))),L.max(p.map(O("dateMax")))]).nice(),u.fixedomain&&(1==u.fixedomain.length&&u.fixedomain.push(u.domain()[1]),u.domain(u.fixedomain)),m.fixedomain&&m.domain(u.fixedomain),k=m.copy(),(h=L.select(t).append("svg").attr("width",l).attr("height",s)).append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",l-f.left-f.right).attr("height",s-f.bottom-d-c).attr("y",-f.top),y=h.insert("g","rect.mouse-catch").attr("transform","translate("+f.left+","+f.top+")").attr("clip-path","url(#clip)"),x=y.append("g"),g=y.append("g"),v=h.append("g").attr("transform","translate("+f.left+","+(s-d-f.bottom)+")"),(b=h.append("g").datum({x:new Date,visible:!1})).append("line").attr("x1",0).attr("x2",0).attr("y1",u.range()[0]).attr("y2",u.range()[1]).attr("class","d3_timeseries mousevline"),b.update=function(){this.attr("transform",function(t){return"translate("+(f.left+m(t.x))+","+f.top+")"}).style("opacity",function(t){return t.visible?1:0})},b.update();var e,a,n,r,i=L.axisBottom().scale(m).tickFormat(m.setformat),o=L.axisLeft().scale(u).tickFormat(u.setformat);w.extent([[k.range()[0],0],[k.range()[1],70]]).on("brush",function(){var t=L.event.selection;m.domain(t.map(k.invert,k)),p.forEach(F),h.select(".focus.x.axis").call(i),b.update(),N()}).on("end",function(){null===L.event.selection&&(m.domain(k.domain()),p.forEach(F),h.select(".focus.x.axis").call(i),b.update(),N())}),h.append("g").attr("class","d3_timeseries focus x axis").attr("transform","translate("+f.left+","+(s-f.bottom-d-c)+")").call(i),v.append("g").attr("class","d3_timeseries x axis").attr("transform","translate(0,80)").call(i),v.append("g").attr("class","d3_timeseries brush").call(w).attr("transform","translate(0, 10)").attr("height",70),h.append("g").attr("class","d3_timeseries y axis").attr("transform","translate("+f.left+","+f.top+")").call(o).append("text").attr("transform","rotate(-90)").attr("x",-f.top-L.mean(u.range())).attr("dy",".71em").attr("y",5-f.left).style("text-anchor","middle").text(u.label),h.append("rect").attr("width",l).attr("class","d3_timeseries mouse-catch").attr("height",s-d).style("opacity",0).on("mousemove",E).on("mouseout",M),_=L.select(t).style("position","relative").append("div").attr("class","d3_timeseries tooltip").style("opacity",0),p.forEach(A),p.forEach(F),e=u.copy().range([70,0]),a=p[0],n=L.line().x(j(a.aes.x,k)).y(j(a.aes.y,e)).curve(a.interpolationFunction).defined(B(a.aes.y)),r=v.insert("path",":first-child").datum(a.data).attr("class","d3_timeseries.line").attr("transform","translate(0,10)").attr("d",n).attr("stroke",a.options.color).attr("stroke-width",a.options.width||1.5).attr("fill","none"),a.hasOwnProperty("stroke-dasharray")&&r.attr("stroke-dasharray",a["stroke-dasharray"])}n.width=function(t){return arguments.length?(l=t,n):l},n.height=function(t){return arguments.length?(s=t,n):s},n.margin=function(t){return arguments.length?(f=t,n):f},L.keys(f).forEach(function(e){n.margin[e]=function(t){return arguments.length?(f[e]=t,n):f[e]}});function t(e){return{tickFormat:function(t){return arguments.length?(e.setformat=t,n):e.setformat},label:function(t){return arguments.length?(e.label=t,n):e.label},domain:function(t){return!arguments.length&&e.fixedomain?e.fixedomain:arguments.length?(e.fixedomain=t,n):null}}}return n.yscale=t(u),n.xscale=t(m),n.addSerie=function(t,e,a){return!t&&0<p.length&&(t=p[0].data),a.color||(a.color=r[p.length%r.length]),p.push({data:t,aes:e,options:a}),n},n}});
